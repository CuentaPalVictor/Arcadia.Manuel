<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arcadia</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8fafc; margin: 0; }
    .header { background: #fff; padding: 16px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .masonry { column-count: 3; column-gap: 16px; }
    .card { background: #fff; margin-bottom: 16px; border-radius: 16px; box-shadow: 0 2px 8px #0001; overflow: hidden; break-inside: avoid; }
    .card img { width: 100%; display: block; cursor: pointer; }
    .card-content { padding: 12px; }
    .tags { margin-top: 8px; }
    .tag { display: inline-block; background: #eee; border-radius: 8px; padding: 2px 8px; font-size: 11px; margin-right: 4px; }
    .search { width: 100%; max-width: 400px; padding: 8px 12px; border-radius: 20px; border: 1px solid #ccc; }
  /* Floating action button (red +) */
  .fab { position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px; border-radius: 50%; background: #e60023; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); border: none; cursor: pointer; z-index: 200; }
  .fab:active { transform: scale(0.97); }
  .fab:focus { outline: 3px solid rgba(230,0,35,0.2); outline-offset: 2px; }
  .fab { transition: transform 150ms ease, box-shadow 150ms ease; }
  .fab:hover { transform: scale(1.08); box-shadow: 0 10px 24px rgba(0,0,0,0.18); }
  .btn-primary { background: #e60023; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
  .btn-primary:hover { background: #b8001b; }
  /* Upload modal styles */
  .upload-form { width: 100%; max-width: 740px; background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); }
  .upload-preview { max-height: 60vh; object-fit: contain; width: 100%; border-radius: 8px; background: #f3f3f3; cursor: pointer; }
  /* Thumbnails */
  .thumbs { display: flex; gap: 8px; margin-top: 8px; overflow-x: auto; padding-bottom: 4px; }
  .thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; cursor: pointer; opacity: 0.85; border: 2px solid transparent; flex: 0 0 auto; }
  .thumb.active { border-color: #e60023; opacity: 1; }
  .form-row { display: flex; gap: 8px; margin-top: 10px; }
  .form-row input, .form-row textarea { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; }
  input[type="text"] { border-radius: 8px; padding: 8px 10px; border: 1px solid #ddd; }
  input[type="text"]:focus { outline: none; border-color: #e60023; box-shadow: 0 0 0 3px rgba(230,0,35,0.06); }
  .form-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    // Datos de muestra
    const samplePins = [
      { id: "1", src: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=1600&auto=format&fit=crop", title: "Cocina minimalista", author: "@nora.design", userId: "1", tags: ["hogar", "diseño", "interiores"] },
      { id: "2", src: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600&auto=format&fit=crop", title: "Montañas al amanecer", author: "@ramiro", userId: "2", tags: ["naturaleza", "viajes"] }
    ];

    // Datos de usuarios de ejemplo
    const sampleUsers = [
      { id: "1", username: "@nora.design", name: "Nora García", savedPins: [] },
      { id: "2", username: "@ramiro", name: "Ramiro Torres", savedPins: [] }
    ];

    // Manejo de autenticación
    function useAuth() {
      const [currentUser, setCurrentUser] = React.useState(() => {
        try {
          const stored = localStorage.getItem('arcadia_current_user');
          if (stored) {
            return JSON.parse(stored);
          }
          return sampleUsers[0]; // Usuario por defecto para demo
        } catch {
          return sampleUsers[0];
        }
      });

      const [users, setUsers] = React.useState(() => {
        try {
          const stored = localStorage.getItem('arcadia_users');
          if (stored) {
            return JSON.parse(stored);
          }
          return sampleUsers;
        } catch {
          return sampleUsers;
        }
      });

      React.useEffect(() => {
        try {
          localStorage.setItem('arcadia_users', JSON.stringify(users));
        } catch (e) {
          console.error('Error saving users:', e);
        }
      }, [users]);

      React.useEffect(() => {
        try {
          localStorage.setItem('arcadia_current_user', JSON.stringify(currentUser));
        } catch (e) {
          console.error('Error saving current user:', e);
        }
      }, [currentUser]);

      const savePin = React.useCallback((pinId) => {
        setUsers(prevUsers => {
          const userIndex = prevUsers.findIndex(u => u.id === currentUser.id);
          if (userIndex === -1) return prevUsers;

          const newUsers = [...prevUsers];
          const user = { ...newUsers[userIndex] };
          
          if (user.savedPins.includes(pinId)) {
            user.savedPins = user.savedPins.filter(id => id !== pinId);
          } else {
            user.savedPins = [...user.savedPins, pinId];
          }
          
          newUsers[userIndex] = user;
          setCurrentUser(user);
          return newUsers;
        });
      }, [currentUser]);

      return { currentUser, users, savePin };
    }

    // Componente para mostrar un pin
    function PinCard({ pin, onOpen, onSave, isSaved }) {
      return React.createElement('div', { className: 'card' },
        React.createElement('img', { 
          src: pin.src, 
          alt: pin.title, 
          onClick: () => onOpen(pin),
          style: { width: '100%', display: 'block', borderRadius: '16px' }
        }),
        React.createElement('div', { className: 'card-content' },
          React.createElement('div', { style: { fontWeight: 'bold' } }, pin.title),
          React.createElement('div', null, pin.author),
          React.createElement('div', { className: 'tags' }, 
            pin.tags.map(t => 
              React.createElement('span', { 
                className: 'tag', 
                key: t 
              }, '#' + t)
            )
          ),
          React.createElement('button', {
            onClick: () => onSave && onSave(),
            className: 'btn' + (isSaved ? ' btn-primary' : ''),
            style: { marginTop: 8, padding: '4px 8px', fontSize: 12 }
          }, isSaved ? 'Guardado' : 'Guardar')
        )
      );
    }

    function ProfilePage({ user, pins, onBack, currentUser }) {
      const [activeTab, setActiveTab] = React.useState('creados');
      const userPins = pins.filter(pin => pin.userId === user.id);
      const savedPins = pins.filter(pin => user.savedPins.includes(pin.id));
      
      return React.createElement('div', null,
        React.createElement('div', { className: 'header', style: { display: 'flex', alignItems: 'center', padding: '16px 24px' } },
          React.createElement('button', { 
            className: 'btn', 
            onClick: onBack, 
            style: { marginRight: '16px' } 
          }, '← Volver'),
          React.createElement('div', { style: { flex: 1 } },
            React.createElement('h1', { 
              style: { fontSize: '24px', margin: '0 0 4px 0' } 
            }, user.name),
            React.createElement('div', { style: { fontSize: '14px', color: '#666' } },
              user.username,
              React.createElement('span', { style: { margin: '0 8px' } }, '•'),
              `${userPins.length} pins creados`,
              React.createElement('span', { style: { margin: '0 8px' } }, '•'),
              `${savedPins.length} pins guardados`
            )
          )
        ),
        React.createElement('div', { className: 'container' },
          React.createElement('div', { 
            style: { 
              display: 'flex',
              gap: '16px',
              marginBottom: '24px',
              borderBottom: '1px solid #eee'
            }
          },
            ['creados', 'guardados'].map(tab => 
              React.createElement('button', {
                key: tab,
                onClick: () => setActiveTab(tab),
                style: {
                  padding: '12px 24px',
                  border: 'none',
                  background: 'none',
                  borderBottom: `2px solid ${activeTab === tab ? '#e60023' : 'transparent'}`,
                  color: activeTab === tab ? '#e60023' : '#666',
                  fontWeight: activeTab === tab ? 'bold' : 'normal',
                  cursor: 'pointer'
                }
              }, tab.charAt(0).toUpperCase() + tab.slice(1))
            )
          ),
          React.createElement('div', { className: 'masonry' },
            (activeTab === 'creados' ? userPins : savedPins).map(pin => 
              React.createElement(PinCard, { 
                pin,
                key: pin.id,
                onOpen: () => {},
                onSave: () => {},
                isSaved: user.savedPins.includes(pin.id)
              })
            )
          )
        )
      );
    }

    function SimilarPage({ tag, pins, onBack, onAdd }) {
      const similarPins = pins.filter(p => p.tags.includes(tag));
      return React.createElement('div', null,
        React.createElement('div', { className: 'header' },
          React.createElement('button', { className: 'btn', onClick: onBack }, '← Volver'),
          React.createElement('span', { style: { fontWeight: 'bold', fontSize: 20, marginLeft: 16 } }, `Imágenes similares: #${tag}`)
        ),
        React.createElement('div', { className: 'container' },
          React.createElement('div', { className: 'masonry' },
            similarPins.map(pin => React.createElement(PinCard, { pin, key: pin.id, onOpen: () => {} }))
          )
        ),
        React.createElement('div', { className: 'footer' }, 'AWS Las ingenieras TecMilenio')
      );
    }

        // Función para comprimir imágenes antes de guardar
        async function compressImage(dataUrl, maxWidth = 800) {
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              // Calculate new dimensions
              let width = img.width;
              let height = img.height;
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              
              // Compress as JPEG with reduced quality
              resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = dataUrl;
          });
        }

        function PinterestClone() {
          const [pins, setPins] = React.useState(() => {
            try {
              const stored = localStorage.getItem('arcadia_pins');
              if (stored) {
                const parsed = JSON.parse(stored);
                // Verify data structure to avoid corruption
                if (Array.isArray(parsed) && parsed.every(pin => 
                  pin && typeof pin === 'object' && 
                  typeof pin.id === 'string' && 
                  typeof pin.src === 'string'
                )) {
                  return parsed;
                }
              }
              return samplePins;
            } catch {
              return samplePins;
            }
          });
          const [query, setQuery] = React.useState('');
          const [page, setPage] = React.useState('main');
          
          // Hook de autenticación
          const { currentUser, users, savePin } = useAuth();

          // Persistir pins en localStorage con manejo de errores mejorado
          React.useEffect(() => {
            const savePins = async () => {
              try {
                // Clean up old data first
                try {
                  localStorage.clear();
                } catch {}

                // Compress images if needed
                const compressedPins = await Promise.all(
                  pins.map(async pin => ({
                    ...pin,
                    src: pin.src.length > 100000 ? await compressImage(pin.src) : pin.src
                  }))
                );

                localStorage.setItem('arcadia_pins', JSON.stringify(compressedPins));
              } catch (e) {
                console.error('Error saving to localStorage:', e);
                // If quota exceeded, try to save without the oldest pins
                if (e.name === 'QuotaExceededError' && pins.length > 10) {
                  try {
                    const reducedPins = pins.slice(-10); // Keep only the 10 most recent
                    localStorage.setItem('arcadia_pins', JSON.stringify(reducedPins));
                    setPins(reducedPins); // Update state to match storage
                  } catch (e2) {
                    console.error('Failed to save even with reduced data:', e2);
                  }
                }
              }
            };
            savePins();
          }, [pins]);

      // Función para manejar clicks en pins
      function handlePinClick(pin) {
        console.log('Pin clicked:', pin);
      }

  // Ref para el input file oculto
  const fileInputRef = React.useRef(null);
  // Estados para modal de subida
  const [uploadModalOpen, setUploadModalOpen] = React.useState(false);
  const [uploadPreview, setUploadPreview] = React.useState(null);
  const [uploadFile, setUploadFile] = React.useState(null);
  const [uploadTitle, setUploadTitle] = React.useState('');
  const [uploadAuthor, setUploadAuthor] = React.useState('@tú');
  const [uploadTags, setUploadTags] = React.useState('subido');
  const [uploadFiles, setUploadFiles] = React.useState([]); // array of {file, src}
  const [uploadIndex, setUploadIndex] = React.useState(0);
  const [uploadLarge, setUploadLarge] = React.useState(false);

      const filtered = pins.filter(pin => 
        pin.title.toLowerCase().includes(query.toLowerCase()) ||
        pin.author.toLowerCase().includes(query.toLowerCase()) ||
        pin.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
      );

      const handleOpenSimilar = React.useCallback((tag) => {
        setPage({ type: 'similar', tag });
      }, []);

      const handleBack = React.useCallback(() => {
        setPage({ type: 'main' });
      }, []);

      const handleAddPin = React.useCallback((newPin) => {
        setPins(prevPins => [newPin, ...prevPins]);
      }, []);

      // Subir imagen desde el dispositivo y añadir como pin
      function onUpload(files) {
        if (!files || files.length === 0) return;
        const list = Array.from(files);
        const readers = list.map(f => new Promise(res => {
          const r = new FileReader();
          r.onload = () => res({ file: f, src: r.result });
          r.readAsDataURL(f);
        }));
        Promise.all(readers).then(results => {
          // Do not auto-save: allow user to add metadata and save manually
          setUploadFiles(results);
          setUploadIndex(0);
          setUploadPreview(results[0].src);
          setUploadFile(results[0].file);
          setUploadTitle(results[0].file.name.replace(/\.[^.]+$/, ''));
          setUploadAuthor('@tú');
          setUploadTags('subido');
          setUploadModalOpen(true);
        });
      }

      async function saveCurrent() {
        if (!uploadPreview || !uploadFile) return;
        const id = String(Date.now());
        const compressedSrc = await compressImage(uploadPreview);
        const newPin = {
          id,
          src: compressedSrc,
          title: uploadTitle || uploadFile.name.replace(/\.[^.]+$/, ''),
          author: currentUser.username,
          userId: currentUser.id,
          tags: (uploadTags || 'subido').split(',').map(t => t.trim()).filter(Boolean)
        };
        setPins(p => [newPin, ...p]);
        // remove saved from uploadFiles and move to next
        const remaining = uploadFiles.slice();
        remaining.splice(uploadIndex, 1);
        setUploadFiles(remaining);
        if (remaining.length > 0) showIndex(uploadIndex % remaining.length);
        else cancelUpload();
      }

      function showIndex(i) {
        if (!uploadFiles || uploadFiles.length === 0) return;
        const idx = (i + uploadFiles.length) % uploadFiles.length;
        setUploadIndex(idx);
        setUploadPreview(uploadFiles[idx].src);
        setUploadFile(uploadFiles[idx].file);
        setUploadTitle(uploadFiles[idx].file.name.replace(/\.[^.]+$/, ''));
        setUploadLarge(false);
      }

  function nextImage() { showIndex(uploadIndex + 1); }
  function prevImage() { showIndex(uploadIndex - 1); }

  // manual save flow — user saves each image with metadata

      function cancelUpload() {
        setUploadModalOpen(false);
        setUploadPreview(null);
        setUploadFile(null);
        setUploadTitle('');
        setUploadAuthor('@tú');
        setUploadTags('subido');
        if (fileInputRef.current) fileInputRef.current.value = null;
      }

      // Función para guardar un pin
      function handleSavePin(pinId) {
        console.log('Guardando pin:', pinId);
      }

      // Persist pins to localStorage whenever they change
      React.useEffect(() => {
        try {
          localStorage.setItem('arcadia_pins', JSON.stringify(pins));
        } catch (e) {
          /* ignore localStorage errors */
        }
      }, [pins]);

      // ESC closes modal
      React.useEffect(() => {
        function onKey(e) {
          if (e.key === 'Escape' && uploadModalOpen) cancelUpload();
        }
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [uploadModalOpen]);

      if (page.type === 'similar') {
        return React.createElement(SimilarPage, {
          tag: page.tag,
          pins,
          onBack: handleBack,
          onAdd: handleAddPin
        });
      }

      if (page.type === 'profile') {
        const user = users.find(u => u.id === page.userId);
        if (user) {
          return React.createElement(ProfilePage, {
            user,
            pins,
            currentUser,
            onBack: handleBack
          });
        }
      }

      // Renderizado principal
      return React.createElement('div', null,
        React.createElement('div', { className: 'header' },
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', padding: '0 16px' } },
            React.createElement('span', { 
              style: { fontWeight: 'bold', fontSize: 20, marginRight: 16 } 
            }, 'Arcadia'),
            React.createElement('input', {
              className: 'search',
              type: 'text',
              value: query,
              onChange: (e) => setQuery(e.target.value),
              placeholder: 'Busca ideas, recetas, lugares...'
            })
          )
        ),
        React.createElement('div', { className: 'container' },
          React.createElement('div', { className: 'masonry' },
            filtered.map(pin =>
              React.createElement(PinCard, {
                pin,
                key: pin.id,
                onOpen: () => handleOpenSimilar(pin.tags[0]),
                onSave: () => savePin(pin.id),
                isSaved: currentUser.savedPins.includes(pin.id)
              })
            )
          )
        ),
        React.createElement('div', { className: 'footer' }, 'AWS Las ingenieras TecMilenio.'),
        // Botón de perfil
        React.createElement('button', {
          className: 'fab',
          onClick: () => setPage({ type: 'profile', userId: currentUser.id }),
          style: { background: '#666', right: '90px' },
          title: 'Ver perfil'
        }, 'P'),
        // input file oculto
        React.createElement('input', {
          type: 'file',
          accept: 'image/*',
          multiple: true,
          ref: fileInputRef,
          style: { display: 'none' },
          onChange: function (e) { onUpload(e.target.files); }
        }),
        // Floating action button en esquina inferior derecha
        React.createElement('button', {
          className: 'fab',
          onClick: function () { fileInputRef.current && fileInputRef.current.click(); },
          title: 'Subir imagen'
        }, '+'),
        // Modal de subida
        uploadModalOpen && React.createElement('div', { className: 'modal-bg' },
          React.createElement('div', { className: 'upload-form' },
            React.createElement('div', null,
              React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                  React.createElement('h3', { style: { margin: 0 } }, 'Subir imagen'),
                  uploadFiles && uploadFiles.length > 1 ? React.createElement('span', { style: { fontSize: 12, color: '#666' } }, String(uploadIndex + 1) + '/' + String(uploadFiles.length)) : null
                ),
                React.createElement('button', { className: 'close', onClick: cancelUpload }, '×')
              ),
              React.createElement('div', { style: { marginTop: 12, display: 'grid', gridTemplateColumns: '1fr 320px', gap: 12 } },
                React.createElement('div', null,
                  uploadPreview ? React.createElement('div', { style: { position: 'relative' } },
                    React.createElement('img', { 
                      src: uploadPreview, 
                      className: 'upload-preview', 
                      alt: 'preview', 
                      onClick: function () { setUploadLarge(l => !l); }, 
                      style: uploadLarge ? { maxHeight: '90vh' } : {} 
                    }),
                    React.createElement('div', {
                      style: {
                        position: 'absolute',
                        bottom: '12px',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        background: 'rgba(0,0,0,0.8)',
                        borderRadius: '24px',
                        padding: '8px',
                        display: 'flex',
                        gap: '8px'
                      }
                    },
                      React.createElement('button', {
                        className: 'btn',
                        onClick: () => {
                          const canvas = document.createElement('canvas');
                          const img = new Image();
                          img.onload = () => {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.filter = 'brightness(1.2) contrast(1.1)';
                            ctx.drawImage(img, 0, 0);
                            setUploadPreview(canvas.toDataURL());
                          };
                          img.src = uploadPreview;
                        },
                        style: { padding: '6px 12px', fontSize: '12px' }
                      }, 'Mejorar'),
                      React.createElement('button', {
                        className: 'btn',
                        onClick: () => {
                          const canvas = document.createElement('canvas');
                          const img = new Image();
                          img.onload = () => {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.filter = 'grayscale(1)';
                            ctx.drawImage(img, 0, 0);
                            setUploadPreview(canvas.toDataURL());
                          };
                          img.src = uploadPreview;
                        },
                        style: { padding: '6px 12px', fontSize: '12px' }
                      }, 'B/N')
                    )
                  ) : React.createElement('div', { style: { height: 240, background: '#fafafa', borderRadius: 8 } }, 'Sin preview'),
                  uploadFiles && uploadFiles.length > 1 ? React.createElement('div', { className: 'thumbs' }, uploadFiles.map(function (it, i) {
                    return React.createElement('img', { key: i, src: it.src, className: 'thumb' + (i === uploadIndex ? ' active' : ''), onClick: function () { showIndex(i); } });
                  })) : null
                ),
                React.createElement('div', null,
                  React.createElement('label', null, 'Titulo'),
                  React.createElement('input', { type: 'text', value: uploadTitle, onChange: function (e) { setUploadTitle(e.target.value); } }),
                  React.createElement('label', { style: { marginTop: 8, display: 'block' } }, 'Autor'),
                  React.createElement('input', { type: 'text', value: uploadAuthor, onChange: function (e) { setUploadAuthor(e.target.value); } }),
                  React.createElement('label', { style: { marginTop: 8, display: 'block' } }, 'Tags (separadas por comas)'),
                  React.createElement('input', { type: 'text', value: uploadTags, onChange: function (e) { setUploadTags(e.target.value); } }),
                  React.createElement('div', { className: 'form-actions' },
                    React.createElement('div', { style: { marginRight: 'auto', display: 'flex', gap: 6 } },
                      React.createElement('button', { className: 'btn', onClick: prevImage, title: 'Anterior' }, '◀'),
                      React.createElement('button', { className: 'btn', onClick: nextImage, title: 'Siguiente' }, '▶')
                    ),
                    React.createElement('div', null,
                      React.createElement('button', { className: 'btn', onClick: function () { setUploadLarge(l => !l); }, style: { marginRight: 6 } }, uploadLarge ? 'Ver menos' : 'Ver más'),
                      React.createElement('button', { className: 'btn-primary', onClick: saveCurrent, style: { marginRight: 6 } }, 'Guardar'),
                      React.createElement('button', { className: 'btn', onClick: cancelUpload, style: { background: '#eee', color: '#333' } }, 'Cerrar')
                    )
                  )
                )
              )
            )
          )
        )
      );
    }  // Fin de PinterestClone

    // Crear y renderizar la aplicación
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(PinterestClone));
  </script>
</body>
</html>
